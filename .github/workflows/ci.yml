name: Continuous Integration
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  RUSTFLAGS: "-D warnings"

jobs:
  unit-tests:
    name: Unit tests
    runs-on: nscloud-ubuntu-22.04-amd64-16x32
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Setup dependencies
        run: |
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler postgresql

          # Add PostgreSQL binaries to PATH
          echo "/usr/lib/postgresql/$(pg_lsclusters | awk 'NR==2 {print $1}')/bin" >> $GITHUB_PATH

      - uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1
        with:
          cache: false
          rustflags: ""

      - name: Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@e38323ef017552d7f7af73a3f4db467f278310ed # v3
        with:
          crate: cargo-nextest
          version: ^0.9

      - name: Unit tests
        run: just test-unit --verbose

  integration-tests:
    name: Integration tests
    runs-on: nscloud-ubuntu-22.04-amd64-16x32
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler postgresql

      - name: Install pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          package_json_file: typescript/package.json

      - name: Install Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2
        with:
          bun-version: latest

      - name: pnpm install
        working-directory: typescript
        run: pnpm install

      - uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1
        with:
          cache: false
          rustflags: ""

      - name: Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@82dee4ba654bd2146511f85f0d013af94670c4de #v1.4

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@e38323ef017552d7f7af73a3f4db467f278310ed # v3
        with:
          crate: cargo-nextest
          version: ^0.9

      - name: Add PostgreSQL binaries to PATH
        run: |
          echo "/usr/lib/postgresql/$(pg_lsclusters | awk 'NR==2 {print $1}')/bin" >> $GITHUB_PATH

      - name: Integration tests
        run: just test-it --verbose
        env:
          FIREHOSE_ETH_MAINNET_URL: ${{ secrets.FIREHOSE_ETH_MAINNET_URL }}
          FIREHOSE_ETH_MAINNET_TOKEN: ${{ secrets.FIREHOSE_ETH_MAINNET_TOKEN }}
          RPC_ETH_MAINNET_URL: ${{ secrets.RPC_ETH_MAINNET_URL }}
          RPC_ETH_BASE_URL: ${{ secrets.RPC_ETH_BASE_URL }}

  rustfmt:
    name: Check rustfmt style
    runs-on: namespace-profile-default
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1
        with:
          toolchain: nightly # Required for unstable features (see `rustfmt.toml` for details)
          components: rustfmt
          cache: false
          rustflags: ""

      - name: Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Check formatting
        run: just fmt-check

  release-check:
    name: Build in release mode
    runs-on: nscloud-ubuntu-22.04-amd64-16x32
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1
        with:
          cache: false
          rustflags: ""

      - name: Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Cargo check (release)
        run: just check --release

  typescript:
    name: TypeScript code style & types
    runs-on: namespace-profile-default
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Install pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          package_json_file: typescript/package.json

      - name: Install dependencies
        working-directory: typescript
        run: pnpm install

      - name: Check formatting
        working-directory: typescript
        run: pnpm lint

      - name: Check types
        working-directory: typescript
        run: pnpm check

  typescript-tests:
    name: TypeScript tests
    runs-on: nscloud-ubuntu-22.04-amd64-16x32
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          submodules: recursive

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler postgresql

      - name: Add PostgreSQL binaries to PATH
        run: |
          echo "/usr/lib/postgresql/$(pg_lsclusters | awk 'NR==2 {print $1}')/bin" >> $GITHUB_PATH

      - uses: actions-rust-lang/setup-rust-toolchain@fb51252c7ba57d633bc668f941da052e410add48 # v1
        with:
          cache: false
          rustflags: ""

      - name: Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@82dee4ba654bd2146511f85f0d013af94670c4de #v1.4

      - name: Install pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          package_json_file: typescript/package.json

      - name: Install dependencies
        working-directory: typescript
        run: pnpm install

      # TODO: Ideally we'd be using a binary built in a previous step here.
      - name: Build binary
        run: cargo build --release -p nozzle

      - name: Add Nozzle binaries to PATH
        run: echo "$(pwd)/target/release" >> $GITHUB_PATH

      - name: Run tests
        working-directory: typescript
        run: pnpm test
