{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Manifest",
  "description": "Complete manifest definition for a derived dataset.\n\nA manifest defines a derived dataset with explicit dependencies, tables, and functions.\nDerived datasets transform and combine data from existing datasets using SQL queries.\nThis is the replacement for the legacy SQL dataset format, providing better\nversioning, dependency management, and schema validation.",
  "type": "object",
  "properties": {
    "dependencies": {
      "description": "External dataset dependencies with version requirements",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/Reference"
      },
      "default": {}
    },
    "functions": {
      "description": "User-defined function definitions mapped by function name",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/Function"
      },
      "default": {}
    },
    "kind": {
      "description": "Dataset kind, must be `manifest`",
      "const": "manifest"
    },
    "tables": {
      "description": "Table definitions mapped by table name",
      "type": "object",
      "additionalProperties": false,
      "default": {},
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_$]*$": {
          "$ref": "#/$defs/Table"
        }
      }
    }
  },
  "required": [
    "kind"
  ],
  "$defs": {
    "ArrowSchema": {
      "description": "Arrow schema representation for serialization.\n\nContains an ordered list of fields that define the structure of a table.",
      "type": "object",
      "properties": {
        "fields": {
          "description": "Ordered list of fields in the schema",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Field"
          }
        }
      },
      "required": [
        "fields"
      ]
    },
    "DataType": {
      "description": "Arrow data type, e.g. `Int32`, `Utf8`, etc.",
      "type": "string"
    },
    "Field": {
      "description": "Arrow field definition with name, type, and nullability.\n\nRepresents a single column in a table schema.",
      "type": "object",
      "properties": {
        "name": {
          "description": "Field name",
          "type": "string"
        },
        "nullable": {
          "description": "Whether the field can contain null values",
          "type": "boolean"
        },
        "type": {
          "description": "Arrow data type of the field",
          "$ref": "#/$defs/DataType"
        }
      },
      "required": [
        "name",
        "type",
        "nullable"
      ]
    },
    "Function": {
      "description": "User-defined function specification.\n\nDefines a custom function with input/output types and implementation source.",
      "type": "object",
      "properties": {
        "inputTypes": {
          "description": "Arrow data types for function input parameters",
          "type": "array",
          "items": {
            "$ref": "#/$defs/DataType"
          }
        },
        "outputType": {
          "description": "Arrow data type for function return value",
          "$ref": "#/$defs/DataType"
        },
        "source": {
          "description": "Function implementation source code and metadata",
          "$ref": "#/$defs/FunctionSource"
        }
      },
      "required": [
        "inputTypes",
        "outputType",
        "source"
      ]
    },
    "FunctionSource": {
      "description": "Source code and metadata for a user-defined function.",
      "type": "object",
      "properties": {
        "filename": {
          "description": "Filename where the function is defined",
          "type": "string"
        },
        "source": {
          "description": "Function implementation source code",
          "type": "string"
        }
      },
      "required": [
        "source",
        "filename"
      ]
    },
    "Reference": {
      "description": "A complete dataset reference combining namespace, name, and revision.\n\nThis type provides a fully versioned identifier for datasets by combining\na namespace, dataset name, and revision using `/` and `@` separators.\n\n## Format\n\nThe string representation follows the format: `<namespace>/<name>@<revision>`\n\n## Examples\n\n```text\nmy_namespace/my_dataset@1.0.0\nmy_namespace/my_dataset@0.4.10-rc.1+20230502\nmy_namespace/my_dataset@latest\nmy_namespace/my_dataset@dev\nmy_namespace/my_dataset@b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9\n```\n\n## PURL Format\n\nReferences can also be represented as Package URLs (PURLs) with the format:\n`pkg:amp/<namespace>/<name>@<revision>`\n\nAll three components must follow their respective validation rules.",
      "type": "string",
      "examples": [
        "my_namespace/my_dataset@1.0.0",
        "my_namespace/my_dataset@0.4.10-rc.1+20230502",
        "my_namespace/my_dataset@latest",
        "my_namespace/my_dataset@dev",
        "my_namespace/my_dataset@b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9",
        "pkg:amp/my_namespace/my_dataset@1.0.0"
      ],
      "pattern": "^(pkg:amp/)?[a-z0-9_]+/[a-z_][a-z0-9_]*@.+$"
    },
    "Table": {
      "description": "Table definition within a derived dataset.\n\nDefines a table with its input source, schema, and network.",
      "type": "object",
      "properties": {
        "input": {
          "description": "Table input source (currently only Views are supported)",
          "$ref": "#/$defs/TableInput"
        },
        "network": {
          "description": "Network this table belongs to",
          "type": "string"
        },
        "schema": {
          "description": "Arrow schema definition for the table",
          "$ref": "#/$defs/TableSchema"
        }
      },
      "required": [
        "input",
        "schema",
        "network"
      ]
    },
    "TableInput": {
      "description": "Input source for a table definition.\n\nCurrently only SQL views are supported as table inputs.",
      "anyOf": [
        {
          "description": "SQL view as table input",
          "$ref": "#/$defs/View"
        }
      ]
    },
    "TableSchema": {
      "description": "Schema definition for a table.\n\nWraps an Arrow schema with field definitions including names, types, and nullability.",
      "type": "object",
      "properties": {
        "arrow": {
          "description": "Arrow schema definition",
          "$ref": "#/$defs/ArrowSchema"
        }
      },
      "required": [
        "arrow"
      ]
    },
    "View": {
      "description": "SQL view definition for table input.",
      "type": "object",
      "properties": {
        "sql": {
          "description": "SQL query defining the view",
          "type": "string"
        }
      },
      "required": [
        "sql"
      ]
    }
  }
}