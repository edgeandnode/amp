{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Manifest",
  "description": "Complete manifest definition for a derived dataset.\n\nA manifest defines a derived dataset with explicit dependencies, tables, and functions.\nDerived datasets transform and combine data from existing datasets using SQL queries.\nThis is the replacement for the legacy SQL dataset format, providing better\nversioning, dependency management, and schema validation.",
  "type": "object",
  "properties": {
    "dependencies": {
      "description": "External dataset dependencies with version requirements",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/Dependency"
      },
      "default": {}
    },
    "functions": {
      "description": "User-defined function definitions mapped by function name",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/Function"
      },
      "default": {}
    },
    "kind": {
      "description": "Dataset kind, must be `manifest`",
      "const": "manifest"
    },
    "name": {
      "description": "Dataset name",
      "$ref": "#/$defs/Name"
    },
    "network": {
      "description": "Network name, e.g., `mainnet`, `sepolia`",
      "type": "string"
    },
    "tables": {
      "description": "Table definitions mapped by table name",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/Table"
      },
      "default": {}
    },
    "version": {
      "description": "Dataset version, e.g., `1.0.0`",
      "$ref": "#/$defs/Version"
    }
  },
  "required": [
    "name",
    "version",
    "kind",
    "network"
  ],
  "$defs": {
    "ArrowSchema": {
      "description": "Arrow schema representation for serialization.",
      "type": "object",
      "properties": {
        "fields": {
          "description": "Ordered list of fields in the schema",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Field"
          }
        }
      },
      "required": [
        "fields"
      ]
    },
    "DataType": {
      "description": "Arrow data type, e.g. `Int32`, `Utf8`, etc.",
      "type": "string"
    },
    "Dependency": {
      "description": "External dataset dependency specification.\n\nDefines a dependency on another dataset with version constraints.",
      "type": "object",
      "properties": {
        "name": {
          "description": "Name of the dependency dataset",
          "type": "string"
        },
        "owner": {
          "description": "Owner/organization of the dependency dataset",
          "type": "string"
        },
        "version": {
          "description": "Semver version requirement for the dependency, e.g. `^1.0.0` or `>=1.0.0 <2.0.0`",
          "$ref": "#/$defs/VersionReq"
        }
      },
      "required": [
        "owner",
        "name",
        "version"
      ]
    },
    "Field": {
      "description": "Arrow field definition with name, type, and nullability.",
      "type": "object",
      "properties": {
        "name": {
          "description": "Field name",
          "type": "string"
        },
        "nullable": {
          "description": "Whether the field can contain null values",
          "type": "boolean"
        },
        "type": {
          "description": "Arrow data type of the field",
          "$ref": "#/$defs/DataType"
        }
      },
      "required": [
        "name",
        "type",
        "nullable"
      ]
    },
    "Function": {
      "description": "User-defined function specification.\n\nDefines a custom function with input/output types and implementation source.",
      "type": "object",
      "properties": {
        "inputTypes": {
          "description": "Arrow data types for function input parameters",
          "type": "array",
          "items": {
            "$ref": "#/$defs/DataType"
          }
        },
        "outputType": {
          "description": "Arrow data type for function return value",
          "$ref": "#/$defs/DataType"
        },
        "source": {
          "description": "Function implementation source code and metadata",
          "$ref": "#/$defs/FunctionSource"
        }
      },
      "required": [
        "inputTypes",
        "outputType",
        "source"
      ]
    },
    "FunctionSource": {
      "description": "Source code and metadata for a user-defined function.",
      "type": "object",
      "properties": {
        "filename": {
          "description": "Filename where the function is defined",
          "type": "string"
        },
        "source": {
          "description": "Function implementation source code",
          "type": "string"
        }
      },
      "required": [
        "source",
        "filename"
      ]
    },
    "Name": {
      "description": "A validated dataset name that enforces naming conventions and constraints.\n\nDataset names must follow strict rules to ensure compatibility across systems,\nfile systems, and network protocols. This type provides compile-time guarantees\nthat all instances contain valid dataset names.\n\n## Format Requirements\n\nA valid dataset name must:\n- **Start** with a lowercase letter (`a-z`) or underscore (`_`)\n- **Contain** only lowercase letters (`a-z`), digits (`0-9`), and underscores (`_`)\n- **Not be empty** (minimum length of 1 character)\n- **Have no spaces** or special characters (except underscore)",
      "type": "string",
      "minLength": 1,
      "pattern": "^[a-z_][a-z0-9_]*$"
    },
    "Table": {
      "description": "Table definition within a derived dataset.\n\nDefines a table with its input source, schema, and network.",
      "type": "object",
      "properties": {
        "input": {
          "description": "Table input source (currently only Views are supported)",
          "$ref": "#/$defs/TableInput"
        },
        "network": {
          "description": "Network this table belongs to",
          "type": "string"
        },
        "schema": {
          "description": "Arrow schema definition for the table",
          "$ref": "#/$defs/TableSchema"
        }
      },
      "required": [
        "input",
        "schema",
        "network"
      ]
    },
    "TableInput": {
      "description": "Input source for a table definition.\n\nCurrently only SQL views are supported as table inputs.",
      "anyOf": [
        {
          "description": "SQL view as table input",
          "$ref": "#/$defs/View"
        }
      ]
    },
    "TableSchema": {
      "description": "Schema definition for a table.",
      "type": "object",
      "properties": {
        "arrow": {
          "description": "Arrow schema definition",
          "$ref": "#/$defs/ArrowSchema"
        }
      },
      "required": [
        "arrow"
      ]
    },
    "Version": {
      "description": "Semver version wrapper with JSON schema support and version manipulation utilities.\n\nProvides serialization and version manipulation utilities for dataset versioning.",
      "type": "string"
    },
    "VersionReq": {
      "description": "Semver version requirement wrapper with JSON schema support.\n\nUsed for specifying dependency version constraints in derived datasets.",
      "type": "string"
    },
    "View": {
      "description": "SQL view definition for table input.",
      "type": "object",
      "properties": {
        "sql": {
          "description": "SQL query defining the view",
          "type": "string"
        }
      },
      "required": [
        "sql"
      ]
    }
  }
}