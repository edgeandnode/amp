{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Manifest",
  "description": "Complete manifest definition for a derived dataset.\n\nA manifest defines a derived dataset with explicit dependencies, tables, and functions.\nDerived datasets transform and combine data from existing datasets using SQL queries.\nThis is the replacement for the legacy SQL dataset format, providing better\nversioning, dependency management, and schema validation.",
  "type": "object",
  "properties": {
    "dependencies": {
      "description": "External dataset dependencies with version requirements",
      "type": "object",
      "additionalProperties": false,
      "default": {},
      "patternProperties": {
        "^[a-zA-Z][a-zA-Z0-9_]*$": {
          "$ref": "#/$defs/DepReference"
        }
      }
    },
    "functions": {
      "description": "User-defined function definitions mapped by function name",
      "type": "object",
      "additionalProperties": false,
      "default": {},
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_$]*$": {
          "$ref": "#/$defs/Function"
        }
      }
    },
    "kind": {
      "description": "Dataset kind, must be `manifest`",
      "const": "manifest"
    },
    "tables": {
      "description": "Table definitions mapped by table name",
      "type": "object",
      "additionalProperties": false,
      "default": {},
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_$]*$": {
          "$ref": "#/$defs/Table"
        }
      }
    }
  },
  "required": [
    "kind"
  ],
  "$defs": {
    "ArrowSchema": {
      "description": "Arrow schema representation for serialization.\n\nContains an ordered list of fields that define the structure of a table.",
      "type": "object",
      "properties": {
        "fields": {
          "description": "Ordered list of fields in the schema",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Field"
          }
        }
      },
      "required": [
        "fields"
      ]
    },
    "DataType": {
      "description": "Arrow data type, e.g. `Int32`, `Utf8`, etc.",
      "type": "string"
    },
    "DepReference": {
      "description": "Dependency reference combining fully qualified name and hash-or-version.\n\nThis is similar to `Reference` but only accepts explicit versions or hashes,\nexcluding symbolic references like \"latest\" or \"dev\".\n\nFormat: `namespace/name@version` or `namespace/name@hash`",
      "type": "string",
      "examples": [
        "my_namespace/my_dataset@1.0.0",
        "my_namespace/my_dataset@0.4.10-rc.1+20230502",
        "my_namespace/my_dataset@b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9"
      ],
      "pattern": "^[a-z0-9_]+/[a-z_][a-z0-9_]*@.+$"
    },
    "Field": {
      "description": "Arrow field definition with name, type, and nullability.\n\nRepresents a single column in a table schema.",
      "type": "object",
      "properties": {
        "name": {
          "description": "Field name",
          "type": "string"
        },
        "nullable": {
          "description": "Whether the field can contain null values",
          "type": "boolean"
        },
        "type": {
          "description": "Arrow data type of the field",
          "$ref": "#/$defs/DataType"
        }
      },
      "required": [
        "name",
        "type",
        "nullable"
      ]
    },
    "Function": {
      "description": "User-defined function specification.\n\nDefines a custom function with input/output types and implementation source.",
      "type": "object",
      "properties": {
        "inputTypes": {
          "description": "Arrow data types for function input parameters",
          "type": "array",
          "items": {
            "$ref": "#/$defs/DataType"
          }
        },
        "outputType": {
          "description": "Arrow data type for function return value",
          "$ref": "#/$defs/DataType"
        },
        "source": {
          "description": "Function implementation source code and metadata",
          "$ref": "#/$defs/FunctionSource"
        }
      },
      "required": [
        "inputTypes",
        "outputType",
        "source"
      ]
    },
    "FunctionSource": {
      "description": "Source code and metadata for a user-defined function.",
      "type": "object",
      "properties": {
        "filename": {
          "description": "Filename where the function is defined",
          "type": "string"
        },
        "source": {
          "description": "Function implementation source code",
          "type": "string"
        }
      },
      "required": [
        "source",
        "filename"
      ]
    },
    "SqlStr": {
      "description": "A string intended to contain SQL, with minimal validation.\n\nThis type performs basic string validation but does **not** parse or validate\nSQL syntax. Actual SQL statement parsing is deferred to the query engine.\n\n[`SqlStr`] is a marker type that provides minimal guarantees: the string is\nnon-empty and contains at least one non-whitespace character.\n\n## Validation Rules\n\n[`SqlStr`] must:\n- **Not be empty** (minimum length of 1 character)\n- **Not be only whitespace** (must contain at least one non-whitespace character)\n\n## Non-Goals\n\nThis type does **not**:\n- Parse SQL syntax\n- Validate SQL statement correctness\n- Check for SQL injection vulnerabilities",
      "type": "string",
      "minLength": 1
    },
    "Table": {
      "description": "Table definition within a derived dataset.\n\nDefines a table with its input source, schema, and network.",
      "type": "object",
      "properties": {
        "input": {
          "description": "Table input source (currently only Views are supported)",
          "$ref": "#/$defs/TableInput"
        },
        "network": {
          "description": "Network this table belongs to",
          "type": "string"
        },
        "schema": {
          "description": "Arrow schema definition for the table",
          "$ref": "#/$defs/TableSchema"
        }
      },
      "required": [
        "input",
        "schema",
        "network"
      ]
    },
    "TableInput": {
      "description": "Input source for a table definition.\n\nCurrently only SQL views are supported as table inputs.",
      "anyOf": [
        {
          "description": "SQL view as table input",
          "$ref": "#/$defs/View"
        }
      ]
    },
    "TableSchema": {
      "description": "Schema definition for a table.\n\nWraps an Arrow schema with field definitions including names, types, and nullability.",
      "type": "object",
      "properties": {
        "arrow": {
          "description": "Arrow schema definition",
          "$ref": "#/$defs/ArrowSchema"
        }
      },
      "required": [
        "arrow"
      ]
    },
    "View": {
      "description": "SQL view definition for table input.",
      "type": "object",
      "properties": {
        "sql": {
          "description": "SQL query defining the view",
          "$ref": "#/$defs/SqlStr"
        }
      },
      "required": [
        "sql"
      ]
    }
  }
}