name: Publish Release

on:
  release:
    types: [published]

jobs:
  copy-release:
    name: Copy Release to Public Repo
    runs-on: ubuntu-latest

    steps:
      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          # Create directory for assets
          mkdir -p assets

          # Download all assets from the release
          gh release download "$RELEASE_TAG" \
            --dir assets \
            --repo ${{ github.repository }}

          # List downloaded assets
          ls -lah assets/

      - name: Create release in public repository
        env:
          GH_TOKEN: ${{ secrets.PUBLISH_RELEASE_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          # Build gh release create command
          ARGS=(
            "$RELEASE_TAG"
            --repo "edgeandnode/amp"
            --title "$RELEASE_NAME"
            --notes "$RELEASE_BODY"
          )

          # Add prerelease flag if needed
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            ARGS+=(--prerelease)
          fi

          # Add all assets
          for asset in assets/*; do
            if [ -f "$asset" ]; then
              ARGS+=("$asset")
            fi
          done

          # Create the release
          gh release create "${ARGS[@]}"
