- name: restore_eth_rpc
  restore: _/eth_rpc@0.0.0

- name: select_alias_special_block_num_empty_relation
  query: |
    SELECT 0 AS _block_num
  failure: |
    projection contains a column alias starting with '_': '_block_num'. Underscore-prefixed names are reserved. Please rename your column

- name: select_alias_special_block_num_table
  query: |
    SELECT 0 AS _block_num FROM eth_rpc.blocks
  failure: |
    projection contains a column alias starting with '_': '_block_num'. Underscore-prefixed names are reserved. Please rename your column

- name: select_1
  query: SELECT 1
  results: |
    [
      {"Int64(1)": 1}
    ]

- name: evm_topic
  query: SELECT evm_topic('Transfer(address indexed from, address indexed to, uint256 value)') AS topic
  results: |
    [
      {
        "topic": "ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"
      }
    ]

- name: evm_decode_log
  query: |
    SELECT evm_decode_log(l.topic1, l.topic2, l.topic3, l.data, 'Transfer(address indexed from, address indexed to, uint256 value)') AS decoded
    FROM eth_rpc.logs l
    WHERE l.topic0 = evm_topic('Transfer(address indexed from, address indexed to, uint256 value)')
    AND l.topic3 IS NULL
    LIMIT 1
  results: |
    [
      {
        "decoded": {
          "from": "06729eb2424da47898f935267bd4a62940de5105",
          "to": "beefbabeea323f07c59926295205d3b7a17e8638",
          "value": "6818627949560085517"
        }
      }
    ]

- name: evm_decode_log_deprecated_name
  query: |
    SELECT evm_decode(l.topic1, l.topic2, l.topic3, l.data, 'Transfer(address indexed from, address indexed to, uint256 value)') AS decoded
    FROM eth_rpc.logs l
    WHERE l.topic0 = evm_topic('Transfer(address indexed from, address indexed to, uint256 value)')
    AND l.topic3 IS NULL
    LIMIT 1
  results: |
    [
      {
        "decoded": {
          "from": "06729eb2424da47898f935267bd4a62940de5105",
          "to": "beefbabeea323f07c59926295205d3b7a17e8638",
          "value": "6818627949560085517"
        }
      }
    ]

- name: eth_call
  query: |
    SELECT eth_rpc.eth_call(from, to, input, arrow_cast(block_num,'Utf8')) AS call
    FROM eth_rpc.transactions
    WHERE tx_index = 2
  results: |
    [
      {
        "call": {
          "data": "08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000015500000000000000000000000000000000000000000000000000000000000000",
          "message": "execution reverted: U"
        }
      }
    ]

- name: eth_call_all_params
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
          evm_encode_hex('0x742d35Cc6634C0532925a3b844Bc454e4438f44e'),
          evm_encode_hex('0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'),
          evm_encode_params(
            evm_encode_hex('0x1111111111111111111111111111111111111111'),
            arrow_cast(1, 'UInt64'),
            'approve(address spender, uint256 amount)'
          ),
          '19000000'
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as result
    FROM test
  results: |
    [{"result": "0000000000000000000000000000000000000000000000000000000000000001"}]

- name: eth_call_null_from
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            NULL,
            evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
            evm_encode_params(
                evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
                'balanceOf(address account)'
            ),
            arrow_cast(block_num,'Utf8')
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as balance
    FROM test
  results: |
    [{"balance": "000000000000000000000000000000000000000000000022ec7859f519b9cabb"}]

- name: eth_call_null_data
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            NULL,
            evm_encode_hex('0x0000000000000000000000000000000000000000'),
            NULL,
            'latest'
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as result
    FROM test
  results: |
    [{"result": ""}]

- name: eth_call_invalid_from_type
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            evm_encode_hex('0x12a137b28608117c2d1f562195afb72651dc2a52c17e04e4cee8df08ccf4e96b'),
            evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
            evm_encode_params(
                evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
                'balanceOf(address account)'
            ),
            arrow_cast(block_num,'Utf8')
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as balance
    FROM test
  failure: |
    'from' address is not a valid address

- name: eth_call_invalid_to_type
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            NULL,
            evm_encode_hex('0x12a137b28608117c2d1f562195afb72651dc2a52c17e04e4cee8df08ccf4e96b'),
            evm_encode_params(
                evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
                'balanceOf(address account)'
            ),
            arrow_cast(block_num,'Utf8')
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as balance
    FROM test
  failure: |
    'to' address is not a valid address

- name: eth_call_invalid_input_data_type
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            NULL,
            evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
            arrow_cast(1234, 'Int64'),
            arrow_cast(block_num,'Utf8')
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as balance
    FROM test
  failure: |
    input data is not a valid data

- name: eth_call_invalid_block_type
  query: |
    with test as(
        SELECT eth_rpc.eth_call(
            NULL,
            evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
            evm_encode_params(
                evm_encode_hex('0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'),
                'balanceOf(address account)'
            ),
            miner
        ) as result from eth_rpc.blocks limit 1
    )
    SELECT
        result.data as balance
    FROM test
  failure: |
    'block' is not a valid block number or tag

- name: evm_decode_params
  query: |
    SELECT evm_decode_params(input, 'function approve(address _spender, uint256 _value)') AS params
    FROM eth_rpc.transactions
    WHERE block_num = 15000000 AND tx_index = 333
  results: |
    [
      {
        "params": {
          "_spender": "abea9132b05a70803a4e85094fd0e1800777fbef",
          "_value": "115792089237316195423570985008687907853269984665640564039457584007913129639935"
        }
      }
    ]

- name: evm_decode_params_array
  query: |
    SELECT evm_decode_params(
      decode('e051f3ca00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002', 'hex'),
      'function example(uint32[] arg)'
    ) AS params
  results: |
    [
      {
        "params": {
          "arg": [0, 1, 2]
        }
      }
    ]

- name: evm_decode_params_array_invalid
  query: |
    SELECT evm_decode_params(
      decode('00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002', 'hex'),
      'function example(uint32[] arg)'
    ) AS params
  results: |
    [
      {
      }
    ]

- name: evm_decode_params_fixed_size_array
  query: |
    SELECT evm_decode_params(
      decode('5777e1a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002', 'hex'),
      'function example(uint32[3] arg)'
    ) AS params
  results: |
    [
      {
        "params": {
          "arg": [0, 1, 2]
        }
      }
    ]

- name: evm_decode_params_fixed_size_array_invalid
  query: |
    SELECT evm_decode_params(
      decode('000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002', 'hex'),
      'function example(uint32[3] arg)'
    ) AS params
  results: |
    [
      {
      }
    ]

- name: evm_decode_params_tuple
  query: |
    SELECT evm_decode_params(
      decode('73e7784e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000', 'hex'),
      'function example((uint32, uint32, string) arg)'
    ) AS params
  results: |
    [
      {
        "params": {
          "arg": {
            "c0": 0,
            "c1": 1,
            "c2": "hello"
          }
        }
      }
    ]

- name: evm_decode_params_tuple_invalid
  query: |
    SELECT evm_decode_params(
      decode('0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000', 'hex'),
      'function example((uint32, uint32, string) arg)'
    ) AS params
  results: |
    [
      {
      }
    ]

- name: evm_decode_params_selector_mismatch
  query: |
    SELECT evm_decode_params(input, 'function approve(address _spender, uint256 _value)') AS params
    FROM eth_rpc.transactions
    WHERE block_num = 15000000 AND tx_index = 334
  results: |
    [{}]

- name: evm_decode_params
  query: |
    SELECT evm_encode_params(to, CAST(123123123 AS DECIMAL(41, 0)), input, 'function example(address _to, uint256 _value, bytes _input) public returns (bool success)') AS encoded
    FROM eth_rpc.transactions
    WHERE block_num = 15000000 AND tx_index = 2
  results: |
    [
      {
        "encoded": "af32b01f000000000000000000000000beefbabeea323f07c59926295205d3b7a17e8638000000000000000000000000000000000000000000000000000000000756b5b30000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000008f000000020000000000000000000000000000000000000000000000000000000003e366320000000000000000000000000000000000000000000000005ea06407f0408000aaaebe6fe48e54f431b0c390cfaf0b017d09d42dc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000bb800000000000000000000000000000000000000000000000000210fa439a7fc040000000000000000000000000000000000"
      }
    ]

- name: evm_encode_then_decode_params
  query: |
    SELECT evm_decode_params(encoded, 'function transfer(address _to, uint256 _value) public returns (bool success)') AS decoded
    FROM (
        SELECT to, evm_encode_params(to, CAST(100 AS DECIMAL(39, 0)), 'function transfer(address _to, uint256 _value) public returns (bool success)') AS encoded
        FROM eth_rpc.transactions
        WHERE block_num = 15000000 AND tx_index = 2
    )
  results: |
    [
      {
        "decoded": {
          "_to": "beefbabeea323f07c59926295205d3b7a17e8638",
          "_value": "100"
        }
      }
    ]

- name: evm_encode_type_scalars
  query: |
    SELECT
      evm_encode_type(CAST(635 AS DECIMAL(39, 0)), 'uint256') AS uint256,
      evm_encode_type(CAST(-635 AS DECIMAL(39, 0)), 'int256') AS int256,
      evm_encode_type(CAST(-635 AS DECIMAL(38, 0)), 'int128') AS int128,
      evm_encode_type('hello world', 'string') AS str,
      evm_encode_type(CAST(100 AS TINYINT), 'int8') AS int8
  results: |
    [
      {
        "uint256": "000000000000000000000000000000000000000000000000000000000000027b",
        "int256": "fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd85",
        "int128": "fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd85",
        "str": "0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000b68656c6c6f20776f726c64000000000000000000000000000000000000000000",
        "int8": "0000000000000000000000000000000000000000000000000000000000000064"
      }
    ]

- name: evm_encode_decode_type_scalars
  query: |
    SELECT
      evm_decode_type(evm_encode_type(CAST(635 AS DECIMAL(39, 0)), 'uint256'), 'uint256') AS uint256,
      evm_decode_type(evm_encode_type(CAST(-635 AS DECIMAL(39, 0)), 'int256'), 'int256') AS int256,
      evm_decode_type(evm_encode_type(CAST(-635 AS DECIMAL(38, 0)), 'int128'), 'int128') AS int128,
      evm_decode_type(evm_encode_type('hello world', 'string'), 'string') AS str,
      evm_decode_type(evm_encode_type(CAST(100 AS TINYINT), 'int8'), 'int8') AS int8
  results: |
    [
      {
        "uint256": "635",
        "int256": "-635",
        "int128": -635,
        "str": "hello world",
        "int8": 100
      }
    ]

- name: evm_encode_type_array_scalar
  query: |
    SELECT evm_encode_type([1, 2, 3], 'int256[]') AS arr
  results: |
    [
      {"arr":"00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"}
    ]

- name: evm_encode_decode_type_array_scalar
  query: |
    SELECT evm_decode_type(evm_encode_type([1, 2, 3], 'int256[]'), 'int256[]') AS arr
  results: |
    [
      {"arr": ["1", "2", "3"]}
    ]

- name: evm_encode_type_array_column
  query: |
    SELECT evm_encode_type([tx_index+1, tx_index+2, tx_index+3], 'int256[]') AS arr
    FROM eth_rpc.transactions
    ORDER BY tx_index
    LIMIT 1
  results: |
    [
      {"arr":"00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"}
    ]

- name: evm_encode_decode_type_array_column
  query: |
    SELECT evm_decode_type(evm_encode_type([tx_index+1, tx_index+2, tx_index+3], 'int256[]'), 'int256[]') AS arr
    FROM eth_rpc.transactions
    ORDER BY tx_index
    LIMIT 1
  results: |
    [
      {"arr": ["1", "2", "3"]}
    ]

- name: evm_encode_type_fixed_array_scalar
  query: |
    SELECT evm_encode_type(arrow_cast([1, 2, 3], 'FixedSizeList(3, Int64)'), 'int256[3]') AS arr
  results: |
    [
      {"arr":"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"}
    ]

- name: evm_encode_decode_type_fixed_array_scalar
  query: |
    SELECT evm_decode_type(evm_encode_type(arrow_cast([1, 2, 3], 'FixedSizeList(3, Int64)'), 'int64[3]'), 'int64[3]') AS arr
  results: |
    [
      {"arr": [1, 2, 3]}
    ]

- name: evm_encode_type_fixed_array_column
  query: |
    SELECT evm_encode_type(arrow_cast([tx_index+1, tx_index+2, tx_index+3], 'FixedSizeList(3, Int64)'), 'int256[3]') AS arr
    FROM eth_rpc.transactions
    ORDER BY tx_index
    LIMIT 1
  results: |
    [
      {"arr":"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003"}
    ]

- name: evm_encode_type_struct_scalar
  query: |
    SELECT evm_encode_type(struct(1, 2, 'str'), '(int256, int256, string)') AS struct
  results: |
    [
      {"struct":"000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000037374720000000000000000000000000000000000000000000000000000000000"}
    ]

- name: evm_encode_decode_type_struct_scalar
  query: |
    SELECT evm_decode_type(evm_encode_type(struct(1, 2, 'str'), '(int256, int8, string)'), '(int256, int8, string)') AS struct
  results: |
    [
      {
        "struct": {
          "c0": "1",
          "c1": 2,
          "c2": "str"
        }
      }
    ]

- name: evm_encode_decode_nested_type
  query: |
    SELECT evm_decode_type(evm_encode_type(struct(1, 2, ['str1', 'str2', 'str3']), '(int256, int8, string[])'), '(int256, int8, string[])') AS struct
  results: |
    [
      {
        "struct": {
          "c0": "1",
          "c1": 2,
          "c2": ["str1", "str2", "str3"]
        }
      }
    ]

- name: evm_encode_type_struct_column
  query: |
    SELECT
      evm_encode_type(struct(tx_index+1, tx_index+2, 'str'), '(int256, int256, string)') AS struct1,
      evm_encode_type(struct(tx_index+1, 'str'), '(int256, string)') AS struct2
    FROM eth_rpc.transactions
    ORDER BY tx_index
    LIMIT 1
  results: |
    [
      {
        "struct1":"000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000037374720000000000000000000000000000000000000000000000000000000000",
        "struct2":"00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000037374720000000000000000000000000000000000000000000000000000000000"
      }
    ]

- name: evm_encode_transaction_values
  query: |
    SELECT evm_encode_type(CAST(value AS DECIMAL(38, 0)), 'uint256') AS value
    FROM eth_rpc.transactions
    WHERE block_num = 15000000
    LIMIT 20
  results: |
    [
      {"value": "000000000000000000000000000000000000000000000000003e606b18c24f0f"},
      {"value": "00000000000000000000000000000000000000000000000000316c27e1c17a8c"},
      {"value": "0000000000000000000000000000000000000000000000000000000000e4e1c0"},
      {"value": "0000000000000000000000000000000000000000000000000000000000e4e1c0"},
      {"value": "0000000000000000000000000000000000000000000000000000000000e4e1c0"},
      {"value": "0000000000000000000000000000000000000000000000000000000000000000"},
      {"value": "0000000000000000000000000000000000000000000000000000000000e4e1c0"},
      {"value": "0000000000000000000000000000000000000000000000000000000000000506"},
      {"value": "000000000000000000000000000000000000000000000000000000000000fa05"},
      {"value": "0000000000000000000000000000000000000000000000000000000000000000"},
      {"value": "000000000000000000000000000000000000000000000000136dcc951d8c0000"},
      {"value": "000000000000000000000000000000000000000000000000134a45a2adcb0000"},
      {"value": "000000000000000000000000000000000000000000000000136dcc951d8c0000"},
      {"value": "000000000000000000000000000000000000000000000000134a45a2adcb0000"},
      {"value": "0000000000000000000000000000000000000000000000000000000000000000"},
      {"value": "000000000000000000000000000000000000000000000000134a45a2adcb0000"},
      {"value": "000000000000000000000000000000000000000000000000001c6bf526340000"},
      {"value": "000000000000000000000000000000000000000000000000136dcc951d8c0000"},
      {"value": "000000000000000000000000000000000000000000000000136dcc951d8c0000"},
      {"value": "0000000000000000000000000000000000000000000000000075e76692293000"}
    ]

- name: evm_encode_type_mismatch_int_to_uint
  query: |
    SELECT evm_encode_type(CAST(-2 AS TINYINT), 'uint8')
  failure: |
    expected int type, got uint8

- name: evm_encode_type_mismatch_int_to_string
  query: |
    SELECT evm_encode_type(CAST(-2 AS TINYINT), 'string')
  failure: |
    expected int type, got string

- name: evm_encode_type_mismatch_string_to_uint
  query: |
    SELECT evm_encode_type('str', 'uint256')
  failure: |
    cannot convert string to solidity type uint256

- name: evm_encode_params_empty
  query: |
    SELECT evm_encode_params('function f()') AS encoded
  results: |
    [{"encoded": "26121ff0"}]

- name: evm_decode_params_empty
  query: |
    SELECT evm_decode_params(decode('26121ff0', 'hex'), 'function f()') AS decoded
  results: |
    [{"decoded": {}}]

- name: evm_encode_decimal_256_with_scale
  query: |
    SELECT evm_encode_type(CAST(635 AS DECIMAL(39, 1)), 'uint256') AS uint256
  failure: |
    Unsupported type Decimal256(39, 1) for Solidity type uint256

- name: evm_encode_decimal_128_with_scale
  query: |
    SELECT evm_encode_type(CAST(635 AS DECIMAL(38, 1)), 'uint128') AS uint128
  failure: |
    Unsupported type Decimal128(38, 1) for Solidity type uint128

- name: evm_encode_decimal_256_with_trailing_zeros
  query: |
    SELECT evm_encode_type(CAST(635000 AS DECIMAL(39, 0)), 'uint256') AS uint256
  results: |
    [{"uint256":"000000000000000000000000000000000000000000000000000000000009b078"}]

- name: evm_encode_decimal_128_with_trailing_zeros
  query: |
    SELECT evm_encode_type(CAST(635000 AS DECIMAL(38, 0)), 'uint128') AS uint128
  results: |
    [{"uint128":"000000000000000000000000000000000000000000000000000000000009b078"}]

- name: select_special_block_num
  query: |
    SELECT _block_num
    FROM eth_rpc.blocks
  results: |
    [{"_block_num": 15000000}]

- name: implicit_cross_join_duplicate_field_names
  query: select * from eth_rpc.blocks, eth_rpc.logs limit 1
  failure: |
    Duplicate field names detected in plan schema: [eth_rpc.blocks._block_num and eth_rpc.logs._block_num, eth_rpc.blocks.block_num and eth_rpc.logs.block_num, eth_rpc.blocks.timestamp and eth_rpc.logs.timestamp]. Please alias your columns to be unique.

- name: implicit_cross_join
  query: select logs.* from eth_rpc.blocks, eth_rpc.logs logs limit 1
  results: |
    [{"_block_num":15000000,"address":"c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","block_hash":"9a71a95be3fe957457b11817587e5af4c7e24836d5b383c430ff25b9286a457f","block_num":15000000,"data":"0000000000000000000000000000000000000000000000005ea0a1fe55143c0d","log_index":0,"timestamp":"2022-06-21T02:28:20Z","topic0":"ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","topic1":"00000000000000000000000006729eb2424da47898f935267bd4a62940de5105","topic2":"000000000000000000000000beefbabeea323f07c59926295205d3b7a17e8638","tx_hash":"beb3d09a644dc0772719f498172af05ed8cd337aaf83c2b5aee43be34fcb9dfb","tx_index":2}]

- name: select_alias_starting_with_underscore
  query: |
    SELECT block_num AS _hello
    FROM eth_rpc.blocks
  failure: |
    projection contains a column alias starting with '_': '_hello'. Underscore-prefixed names are reserved. Please rename your column

- name: select_alias_starting_with_underscore_subquery
  query: |
    SELECT 0 AS zero
    FROM (SELECT block_num as _hello FROM eth_rpc.blocks)
  failure: |
    projection contains a column alias starting with '_': '_hello'. Underscore-prefixed names are reserved. Please rename your column

- name: basic_explain
  query: EXPLAIN select block_num FROM eth_rpc.blocks
  results: |
    [{"plan":"TableScan: eth_rpc.blocks projection=[block_num]","plan_type":"logical_plan"},{"plan":"DataSourceExec: file_groups={1 group: [[015000000-9b7d212e120c1da4.parquet]]}, projection=[block_num], output_ordering=[block_num@0 ASC NULLS LAST], file_type=parquet, predicate=true\n","plan_type":"physical_plan"}]

- name: select_empty
  query: SELECT block_num FROM eth_rpc.blocks WHERE eth_rpc.blocks.block_num > 90000000000;
  results: |
    []
  recordBatchCount: 2 # extra batch for app_metadata to signal completion

- name: evm_address_with_0x_prefix
  query: |
    SELECT address
    FROM eth_rpc.logs
    WHERE address = evm_encode_hex('0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')
    LIMIT 1
  results: |
    [{"address":"c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"}]

- name: evm_address_with_prefix
  query: |
    SELECT tx_hash
    FROM eth_rpc.transactions
    WHERE tx_hash = evm_encode_hex('0x7ecdeea40834539df43b388d62c8e6bdee49107d10114b0d05c6adec1d16e322')
    LIMIT 1
  results: |
    [{"tx_hash":"7ecdeea40834539df43b388d62c8e6bdee49107d10114b0d05c6adec1d16e322"}]

- name: evm_address_without_prefix
  query: |
    SELECT tx_hash
    FROM eth_rpc.transactions
    WHERE tx_hash = evm_encode_hex('7ecdeea40834539df43b388d62c8e6bdee49107d10114b0d05c6adec1d16e322')
    LIMIT 1
  results: |
    [{"tx_hash":"7ecdeea40834539df43b388d62c8e6bdee49107d10114b0d05c6adec1d16e322"}]

- name: evm_address_invalid_hex
  query: |
    SELECT evm_encode_hex('0x123')
  failure: |
    invalid hex string: odd number of digits

- name: evm_address_empty_string
  query: |
    SELECT evm_encode_hex('')
  failure: |
    expected 20 or 32 bytes, got 0

- name: evm_address_no_args
  query: |
    SELECT evm_encode_hex()
  failure: |
    'evm_encode_hex' does not support zero arguments No function matches the given name and argument types 'evm_encode_hex()'
- name: evm_decode_hex_bytes20_address
  query: SELECT evm_decode_hex(address) as address FROM eth_rpc.logs limit 1;
  results: |
    [{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"}]

- name: evm_decode_hex_bytes32
  query: SELECT evm_decode_hex(tx_hash) as tx_hash FROM eth_rpc.transactions limit 1;
  results: |
    [{"tx_hash":"0x7ecdeea40834539df43b388d62c8e6bdee49107d10114b0d05c6adec1d16e322"}]

- name: evm_decode_hex_null
  query: SELECT evm_decode_hex(topic3) FROM eth_rpc.logs limit 1;
  results: |
    [{}]

- name: evm_decode_hex_no_args
  query: SELECT evm_decode_hex()
  failure: |
    'evm_decode_hex' does not support zero arguments

- name: evm_decode_hex_invalid_type
  query: SELECT evm_decode_hex(1)
  failure: |
    failed No function matches the given name and argument types
- name: shift_units_int8_int8
  query: SELECT shift_units(arrow_cast(10,'Int8'),arrow_cast(3,'Int8')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_int16_int16
  query: SELECT shift_units(arrow_cast(10,'Int16'),arrow_cast(3,'Int16')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_int32_int32
  query: SELECT shift_units(arrow_cast(10,'Int32'),arrow_cast(3,'Int32')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_int64_int64
  query: SELECT shift_units(arrow_cast(10,'Int64'),arrow_cast(3,'Int64')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_uint8_uint8
  query: SELECT shift_units(arrow_cast(10,'UInt8'),arrow_cast(3,'UInt8')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_uint16_uint16
  query: SELECT shift_units(arrow_cast(10,'UInt16'),arrow_cast(3,'UInt16')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_uint32_uint32
  query: SELECT shift_units(arrow_cast(10,'UInt32'),arrow_cast(3,'UInt32')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_uint64_uint64
  query: SELECT shift_units(arrow_cast(10,'UInt64'),arrow_cast(3,'UInt64')) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_utf8_utf8
  query: SELECT shift_units('1.376988483056381409', '18') AS val;
  results: |
    [{"val": "1376988483056381409"}]

- name: shift_units_no_arguments_fails
  query: SELECT shift_units();
  failure: |
    does not support zero arguments No function matches the given name and argument types

- name: shift_units_invalid_string_fails
  query: SELECT shift_units('not_a_number', 18) AS wei;
  failure: |
    failed to parse value: invalid digit found in string

- name: shift_units_invalid_units_fails
  query: SELECT shift_units('1.5', 'not_a_number') AS wei;
  failure: |
    failed to parse integer: invalid digit found in string

- name: shift_units_null_value_fails
  query: SELECT shift_units(NULL, 18) AS wei;
  failure: |
    expected numeric type or Utf8 for first argument, got Null

- name: shift_units_null_units_fails
  query: SELECT shift_units('1.5', NULL) AS wei;
  failure: |
    expected numeric type for second argument, got Null

- name: shift_units_zero_units_succeeds
  query: SELECT shift_units('1.5', 0) AS value;
  results: |
    [{"value": "1.5"}]

- name: shift_units_negative_units_succeeds
  query: SELECT shift_units('1.5', -18) AS value;
  results: |
    [{"value": "0.0000000000000000015"}]

- name: shift_units_array_value_succeeds
  query: SELECT shift_units(value,3) as value from eth_rpc.transactions where value = '28998036497399455000';
  results: |
    [{"value": "28998036497399455000000"}]

- name: shift_units_array_units_succeeds
  query: SELECT shift_units('1.2422323',value) as value from eth_rpc.transactions where value = '0' limit 1;
  results: |
    [{"value": "1.2422323"}]

- name: shift_units_value_float32_succeeds
  query: SELECT shift_units(arrow_cast(10,'Float32'),3) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_value_float64_succeeds
  query: SELECT shift_units(arrow_cast(10,'Float64'),3) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_value_decimal128_succeeds
  query: SELECT shift_units(arrow_cast(10,'Decimal128(38,0)'),3) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_value_decimal256_succeeds
  query: SELECT shift_units(arrow_cast(10,'Decimal256(38,0)'),3) AS val;
  results: |
    [{"val": "10000"}]

- name: shift_units_nested_succeeds
  query: SELECT shift_units(shift_units(value,-18),18) as value from eth_rpc.transactions where value = '28998036497399455000';
  results: |
    [{"value": "28998036497399455000"}]

- name: shift_units_nested_succeeds
  query: SELECT shift_units(shift_units(value,-18),18) as value from eth_rpc.transactions where value = '28998036497399455000';
  results: |
    [{"value": "28998036497399455000"}]

- name: shift_units_max_units_fails
  query: SELECT shift_units(value,33) as value from eth_rpc.transactions where value = '28998036497399455000';
  failure: |
    units must be between -32 and 32

- name: shift_units_max_negative_units_fails
  query: SELECT shift_units(value,-33) as value from eth_rpc.transactions where value = '28998036497399455000';
  failure: |
    units must be between -32 and 32
