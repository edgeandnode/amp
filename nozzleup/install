#!/usr/bin/env bash
set -eo pipefail

# Configuration
REPO="${NOZZLE_REPO:-edgeandnode/project-nozzle}"
REF="${NOZZLE_REF:-main}"
BASE=${XDG_CONFIG_HOME:-$HOME}
DIR=${NOZZLE_DIR-"$BASE/.nozzle"}
BIN="$DIR/bin"
GITHUB_TOKEN="${GITHUB_TOKEN:-}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
info() {
    echo -e "${GREEN}nozzleup:${NC} $1"
}

warn() {
    echo -e "${YELLOW}nozzleup: warning:${NC} $1" >&2
}

error() {
    echo -e "${RED}nozzleup: error:${NC} $1" >&2
    exit 1
}

# Check for required commands
need() {
    if ! command -v "$1" >/dev/null 2>&1; then
        error "Required command '$1' not found. Please install it first"
    fi
}

# Detect platform
get_platform() {
    local platform
    platform=$(uname -s | tr '[:upper:]' '[:lower:]')

    case $platform in
        linux)
            echo "linux"
            ;;
        darwin)
            echo "darwin"
            ;;
        *)
            error "Unsupported platform: $platform"
            ;;
    esac
}

# Detect architecture
get_arch() {
    local arch
    arch=$(uname -m)

    case $arch in
        x86_64|amd64)
            echo "x86_64"
            ;;
        arm64|aarch64)
            echo "aarch64"
            ;;
        *)
            error "Unsupported architecture: $arch"
            ;;
    esac
}

# Download a file from GitHub
download_asset() {
    local version=$1
    local asset_name=$2
    local output=$3

    if [ -n "$GITHUB_TOKEN" ]; then
        # Private repository: use GitHub API
        local release_url="https://api.github.com/repos/$REPO/releases/tags/${version}"

        # Get asset ID
        local asset_id
        asset_id=$(curl -sSf \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$release_url" 2>/dev/null \
            | grep -B 3 "\"name\": \"$asset_name\"" \
            | grep '"id"' \
            | head -1 \
            | sed -E 's/.*"id": ([0-9]+).*/\1/')

        if [ -z "$asset_id" ]; then
            return 1
        fi

        # Download asset
        if ! curl -sSfL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "https://api.github.com/repos/$REPO/releases/assets/$asset_id" \
            -o "$output"; then
            return 1
        fi
    else
        # Public repository: use direct URL
        local download_url="https://github.com/$REPO/releases/download/${version}/${asset_name}"

        if ! curl -sSfL "$download_url" -o "$output"; then
            return 1
        fi
    fi

    return 0
}

# Get the latest version
get_latest_version() {
    local args=(-sSf)

    if [ -n "$GITHUB_TOKEN" ]; then
        args+=(-H "Authorization: Bearer $GITHUB_TOKEN")
    fi

    local latest=$(curl "${args[@]}" \
        "https://api.github.com/repos/$REPO/releases/latest" 2>/dev/null \
        | grep '"tag_name"' \
        | sed -E 's/.*"([^"]+)".*/\1/')

    if [ -z "$latest" ]; then
        error "Failed to get latest version"
    fi

    echo "$latest"
}

# Add to PATH and display appropriate next steps
configure_path() {
    # Check if already in PATH
    if [[ ":$PATH:" == *":${BIN}:"* ]]; then
        info "Already in PATH. Run 'nozzleup' to install nozzle"
        return
    fi

    local profile=""
    case $SHELL in
        */zsh)
            profile="${ZDOTDIR-"$HOME"}/.zshenv"
            ;;
        */bash)
            profile="$HOME/.bashrc"
            ;;
        */fish)
            profile="$HOME/.config/fish/config.fish"
            ;;
        */ash)
            profile="$HOME/.profile"
            ;;
        *)
            warn "Unknown shell"
            ;;
    esac

    # Add to PATH
    local success=false
    if [[ $profile != "" ]]; then
      if [[ "$SHELL" == */fish ]]; then
          if { echo >> "$profile" && echo "fish_add_path -a $BIN" >> "$profile"; } 2>/dev/null; then
              info "Added $BIN to your PATH in $profile"
              success=true
          else
              warn "Failed to add to PATH. Please manually add: fish_add_path -a $BIN"
          fi
      else
          if { echo >> "$profile" && echo "export PATH=\"\$PATH:$BIN\"" >> "$profile"; } 2>/dev/null; then
              info "Added $BIN to your PATH in $profile"
              success=true
          else
              warn "Failed to add to PATH. Please manually add: export PATH=\"\$PATH:$BIN\""
          fi
      fi
    fi

    if [ "$success" = true ]; then
        info "Run 'source $profile' or start a new terminal session"
        info "Then run 'nozzleup' to install nozzle"
    else
        warn "Could not automatically add nozzleup to your PATH"
        warn "Please manually add $BIN to your PATH, then run 'nozzleup' to install nozzle"
    fi
}

# Main installation
main() {
    info "Installing nozzleup ..."

    # Check requirements
    need curl

    # Create directories
    mkdir -p "$BIN"

    # Detect system
    local platform arch
    platform=$(get_platform)
    arch=$(get_arch)

    info "Platform: $platform, Architecture: $arch"

    # Get latest nozzleup version
    local version
    if [ -n "$GITHUB_TOKEN" ]; then
        info "Using GitHub token for private repository access"
    fi

    version=$(get_latest_version)
    info "Latest nozzleup version: $version"

    # Download nozzleup binary
    local artifact_name="nozzleup-${platform}-${arch}"
    local temp_binary
    temp_binary=$(mktemp)
    trap "rm -f $temp_binary" EXIT

    info "Downloading $artifact_name ..."
    if ! download_asset "$version" "$artifact_name" "$temp_binary"; then
        error "Failed to download nozzleup"
    fi

    # Verify download
    if [ ! -s "$temp_binary" ]; then
        error "Downloaded binary is empty"
    fi

    # Install binary
    mv "$temp_binary" "$BIN/nozzleup"
    chmod +x "$BIN/nozzleup"

    configure_path

    info "Installation complete!"
}

main "$@"
