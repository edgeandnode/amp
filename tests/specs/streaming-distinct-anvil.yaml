# Streaming DISTINCT ON and GROUP BY tests using Anvil
#
# Tests that DISTINCT ON and GROUP BY work in streaming queries when _block_num
# is the first column. UNION ALL is used to produce duplicate rows so the
# deduplication / aggregation is observable in the results.

- anvil: {}

- name: mine_initial
  anvil_mine: 3

- name: dump_initial
  dataset: _/anvil_rpc@0.0.0
  end: 3

# DISTINCT ON over plain blocks (with a non-block_num column)
- name: register_distinct_stream
  stream: |
    SELECT DISTINCT ON (_block_num) _block_num, block_num, gas_used
    FROM (
      SELECT _block_num, block_num, gas_used FROM anvil_rpc.blocks
      UNION ALL
      SELECT _block_num, block_num, gas_used FROM anvil_rpc.blocks
    )
    SETTINGS stream = true

- name: take_initial_distinct
  stream: register_distinct_stream
  take: 4
  results: |
    [
      {"_block_num": 0, "block_num": 0, "gas_used": 0},
      {"_block_num": 1, "block_num": 1, "gas_used": 0},
      {"_block_num": 2, "block_num": 2, "gas_used": 0},
      {"_block_num": 3, "block_num": 3, "gas_used": 0}
    ]

# GROUP BY with _block_num as the first group column
- name: register_group_by_stream
  stream: |
    SELECT COUNT(*) AS cnt
    FROM (
      SELECT _block_num, block_num FROM anvil_rpc.blocks
      UNION ALL
      SELECT _block_num, block_num FROM anvil_rpc.blocks
    )
    GROUP BY _block_num, block_num
    SETTINGS stream = true

- name: take_initial_group_by
  stream: register_group_by_stream
  take: 4
  results: |
    [
      {"cnt": 2},
      {"cnt": 2},
      {"cnt": 2},
      {"cnt": 2}
    ]

# DISTINCT ON over a join (parent-child self-join duplicated with UNION ALL).
# Uses block_num() to get the block number without needing _block_num in the subquery.
# Block 0 (genesis) has no parent in the dataset, so the join starts at block 1.
- name: register_distinct_join_stream
  stream: |
    SELECT DISTINCT ON (block_num()) block_num(), parent_num
    FROM (
      SELECT child.block_num, parent.block_num AS parent_num
      FROM anvil_rpc.blocks child
      JOIN anvil_rpc.blocks parent ON child.parent_hash = parent.hash
      UNION ALL
      SELECT child.block_num, parent.block_num AS parent_num
      FROM anvil_rpc.blocks child
      JOIN anvil_rpc.blocks parent ON child.parent_hash = parent.hash
    )
    SETTINGS stream = true

- name: take_initial_distinct_join
  stream: register_distinct_join_stream
  take: 3
  results: |
    [
      {"block_num()": 1, "parent_num": 0},
      {"block_num()": 2, "parent_num": 1},
      {"block_num()": 3, "parent_num": 2}
    ]

- name: mine_more
  anvil_mine: 2

- name: dump_more
  dataset: _/anvil_rpc@0.0.0
  end: 5

- name: take_incremental_distinct
  stream: register_distinct_stream
  take: 2
  results: |
    [
      {"_block_num": 4, "block_num": 4, "gas_used": 0},
      {"_block_num": 5, "block_num": 5, "gas_used": 0}
    ]

- name: take_incremental_group_by
  stream: register_group_by_stream
  take: 2
  results: |
    [
      {"cnt": 2},
      {"cnt": 2}
    ]

- name: take_incremental_distinct_join
  stream: register_distinct_join_stream
  take: 2
  results: |
    [
      {"block_num()": 4, "parent_num": 3},
      {"block_num()": 5, "parent_num": 4}
    ]
