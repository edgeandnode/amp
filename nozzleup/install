#!/bin/sh

# This is just a little script that can be downloaded from the internet to
# install `nozzleup`. It just does platform detection, downloads the installer
# and runs it.

main() {
    need uname
    need curl
    need mktemp
    need chmod
    need rm
    need rmdir

    # TODO: Remove this when we move to a public repository
    if [ -n "$GITHUB_TOKEN" ]; then
        need grep
        need head
        need sed
    fi

    local platform=$(get_platform)
    local arch=$(get_architecture)
    info "Installing nozzleup"
    info "Platform: $platform; Architecture: $arch"

    # Download
    local artifact="nozzleup-${platform}-${arch}"
    local tmpdir="$(ensure mktemp -d)"
    local tmpbin="$tmpdir/nozzleup"

    info "Downloading nozzleup"
    download_asset "$artifact" "$tmpbin"

    # Initialize
    info "Initializing nozzleup"
    ensure chmod +x "$tmpbin"
    ensure "$tmpbin" init "$@"

    # Cleanup
    ignore rm "$tmpbin"
    ignore rmdir "$tmpdir"
}

download_asset() {
    local artifact=$1
    local output=$2
    local opts="--proto =https --tlsv1.2 --silent --show-error --fail --location"

    # TODO: Remove this when we move to a public repository
    if [ -n "$GITHUB_TOKEN" ]; then
        local url="https://api.github.com/repos/edgeandnode/project-nozzle/releases/latest"
        local asset=$(ensure curl $opts \
            --header "Authorization: Bearer $GITHUB_TOKEN" \
            --header "Accept: application/vnd.github.v3+json" \
            "$url" | grep -B 3 "\"name\": \"$artifact\"" | grep '"id"' | head -1 | sed -E 's/.*"id": ([0-9]+).*/\1/')

        if [ -z "$asset" ]; then
            error "failed to find asset: $artifact"
            exit 1
        fi

        ensure curl $opts \
            --header "Authorization: Bearer $GITHUB_TOKEN" \
            --header "Accept: application/octet-stream" \
            "https://api.github.com/repos/edgeandnode/project-nozzle/releases/assets/$asset" \
            --output "$output"
    else
        local url="https://github.com/edgeandnode/project-nozzle/releases/latest/download/${artifact}"
        ensure curl $opts "$url" --output "$output"
    fi
}

get_platform() {
    local platform=$(ensure uname -s)
    case $platform in
        Linux)
            echo "linux"
            ;;
        Darwin)
            echo "darwin"
            ;;
        *)
            error "Unsupported platform: $platform"
            exit 1
            ;;
    esac
}

get_architecture() {
    local arch=$(ensure uname -m)
    case $arch in
        x86_64|amd64)
            echo "x86_64"
            ;;
        arm64|aarch64)
            echo "aarch64"
            ;;
        *)
            error "Unsupported architecture: $arch"
            exit 1
            ;;
    esac
}

info() {
    printf "\033[0;32minfo:\033[0m %s\n" "$1"
}

error() {
    printf "\033[0;31merror:\033[0m %s\n" "$1" >&2
}

need() {
    if ! command -v "$1" >/dev/null 2>&1; then
        error "required command not found: $1"
        exit 1
    fi
}

ensure() {
    if ! "$@"; then
        error "command failed: $*"
        exit 1
    fi
}

ignore() {
    "$@"
}

main "$@"
