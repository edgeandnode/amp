name: Claude Code Review

on:
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      github.event.issue.pull_request && 
      contains(github.event.comment.body, '@claude /review')
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Please review this pull request and provide feedback on:
            1. Potential bugs, such as:
               - Off-by-one
               - Incorrect conditionals
               - Use of wrong variable when multiple variables of same type are in scope
               - `min` vs `max`, `first` vs `last`, flipped ordering
               - Iterating over hashmap/hashset in order-sensitive operation
            2. Panic branches that cannot be locally proven to be unreachable:
                - `unwrap` or `expect`
                - Indexing operations 
                - Panicking operations on external data
            3. Dead code that is not caught by warnings:
              - Overriding values that should be read first
              - Silently dead code due to `pub`
              - `todo!()` or `dbg!()`
            4. Performance:
               - Blocking operations in async code
               - DB connection with lifetimes that exceed a local scope
            5. Inconsistencies between comments and code
            6. Backwards compatibility:
               - Changes to `Deserialize` structs that break existing data.
               - Check that DB migrations should keep compatibility when possible:
                 - Use `IF NOT EXIST`.
                 - Avoid dropping columns or altering their data types. 
                 - Check if migration can be made friendly to rollbacks. 
               - Breaking changes to HTTP APIs or CLIs.
            7. Documentation:
               - The `config.sample.toml` should be kept up-to-date.
            8. Security concerns
            9. Testing:
              - Reduced test coverage without justification
              - Tests that don't actually test the intended behavior
              - Tests with race conditions or non-deterministic behavior
              - Integration tests that should be unit tests (or vice versa)
              - Changes to existing tests that weaken assertions
              - Changes to tests that are actually a symptom of breaking changes to user-visible behaviour.
            
            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.
          
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.anthropic.com/en/docs/claude-code/sdk#command-line for available options
          claude_args: '--allowed-tools "Read,Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

