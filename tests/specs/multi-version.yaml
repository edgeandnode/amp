- name: restore_eth_firehose
  restore: _/eth_firehose@0.0.0

- name: register_multi_version_v1
  dataset: multi_version
  tag: "0.0.1"
  config: v1.config.ts
  end: 15000000

- name: dump_multi_version_v1
  dataset: _/multi_version@0.0.1
  config: v1.config.ts
  end: 15000000

- name: register_multi_version_v2
  dataset: multi_version
  tag: "0.0.2"
  config: v2.config.ts
  end: 15000000

- name: dump_multi_version_v2
  dataset: _/multi_version@0.0.2
  config: v2.config.ts
  end: 15000000

# Test queries with versioned dataset names
- name: query_v1_versioned_name
  query: SELECT * FROM "_/multi_version@0.0.1".blocks ORDER BY block_num LIMIT 1
  results: |
    [
      {"_block_num":15000000,"block_num":15000000,"gas_limit":30000000,"gas_used":29998802,"hash":"9a71a95be3fe957457b11817587e5af4c7e24836d5b383c430ff25b9286a457f","miner":"ea674fdde714fd979de3edf0f56aa9716b898ec8","nonce":11581608188404422748,"parent_hash":"93a8a23a2f5296db7251ab4c5e9b10bdc5a6c9c4ed56fb230dc729d3dc03a138"}
    ]

- name: query_v2_versioned_name
  query: SELECT * FROM "_/multi_version@0.0.2".blocks ORDER BY block_num LIMIT 1
  results: |
    [
      {"_block_num":15000000,"block_num":15000000,"gas_limit":30000000,"hash":"9a71a95be3fe957457b11817587e5af4c7e24836d5b383c430ff25b9286a457f","parent_hash":"93a8a23a2f5296db7251ab4c5e9b10bdc5a6c9c4ed56fb230dc729d3dc03a138"}
    ]

# Test queries with non-versioned dataset names (should point to latest version)
- name: query_latest_version_non_versioned
  query: SELECT * FROM multi_version.blocks ORDER BY block_num LIMIT 1
  results: |
    [
      {"_block_num":15000000,"block_num":15000000,"gas_limit":30000000,"hash":"9a71a95be3fe957457b11817587e5af4c7e24836d5b383c430ff25b9286a457f","parent_hash":"93a8a23a2f5296db7251ab4c5e9b10bdc5a6c9c4ed56fb230dc729d3dc03a138"}
    ]

# Test field availability for different versions
- name: query_v1_specific_fields
  query: SELECT nonce, gas_used FROM "_/multi_version@0.0.1".blocks ORDER BY block_num LIMIT 1
  results: |
    [
      {"gas_used":29998802,"nonce":11581608188404422748}
    ]

- name: query_v2_missing_fields_should_fail
  query: SELECT nonce FROM "_/multi_version@0.0.2".blocks
  failure: |
    No field named nonce. Valid fields are \"_/multi_version@0.0.2\".blocks._block_num, \"_/multi_version@0.0.2\".blocks.block_num, \"_/multi_version@0.0.2\".blocks.gas_limit, \"_/multi_version@0.0.2\".blocks.hash, \"_/multi_version@0.0.2\".blocks.parent_hash

# Test count queries for different versions
- name: query_v1_count
  query: SELECT count(*) as total_blocks FROM "_/multi_version@0.0.1".blocks
  results: |
    [
      {"total_blocks":1}
    ]

- name: query_v2_count
  query: SELECT count(*) as total_blocks FROM "_/multi_version@0.0.2".blocks
  results: |
    [
      {"total_blocks":1}
    ]

- name: query_same_table_union
  query: select gas_limit,block_num,hash from multi_version.blocks union select gas_limit,block_num,hash from "_/multi_version@0.0.2".blocks order by block_num limit 3
  results: |
    [
      {"block_num":15000000,"gas_limit":30000000,"hash":"9a71a95be3fe957457b11817587e5af4c7e24836d5b383c430ff25b9286a457f"}
    ]
