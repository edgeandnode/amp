# BlockComplete Message and AlignedMessageStream

Add `QueryMessage::BlockComplete(BlockNum)` optimization and interleave it in data batches to provide completion information before the end of current block range.

---

## Update QueryMessage Enum

**Goal:**  
Add new message variant to signal block completion without guarantees on emission timing.

**Implementation:**  
- Add `BlockComplete(BlockNum)` to `QueryMessage` enum in `dump/src/streaming_query.rs`
- This is purely an optimization for consumers wanting completion info

**Notes:**  
- No guarantees when `BlockComplete` is emitted - not for every block number
- Consumers should not rely on it for correctness, only optimization

---

## Create AlignedMessageStream Module

**Goal:**  
Wrapper stream that validates batch ordering and emits `BlockComplete` messages at appropriate block boundaries.

**Implementation:**  
- New module `dump/src/aligned_message_stream.rs`
- Adapts `Stream<Item = Result<QueryMessage, BoxError>>`
- Core state: track last block number `n` emitted
- On `Data(RecordBatch)`: validate ordered by `_block_num` (except reorgs)
- Split batches when block changes: emit remaining data for block `n`, then `BlockComplete(n)`
- On `MicrobatchEnd`: clear current block tracking

**Notes:**  
- Ordering validation skipped during reorg messages
- Module is separate from core streaming query logic
- Maintains existing QueryMessage API

---

## Batch Splitting Logic

**Goal:**  
Split RecordBatch when `_block_num` values change to emit clean block boundaries.

**Implementation:**  
- Extract `_block_num` column from RecordBatch using Arrow APIs
- When block number changes mid-batch: split into (current_block_data, next_block_data)  
- Emit current block data, then `BlockComplete(n)`, then next block data
- Handle edge cases: missing column, empty batches, single-block batches

**Notes:**  
- Preserves all columns in split batches
- Must handle various Arrow data types for `_block_num`

---

## Update Stream Consumers

**Goal:**  
Ensure existing consumers handle new `BlockComplete` message variant.

**Implementation:**  
- Update `server/src/service.rs` streaming query handling
- Update `dump/src/core/sql_dataset.rs` to handle `BlockComplete` (likely pass-through)
- Add match arms for new message variant

**Notes:**  
- Most consumers can ignore `BlockComplete` messages
- Only optimization-aware consumers need to act on them